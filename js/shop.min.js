var requestURL="data/data.json",request=new XMLHttpRequest;const body=document.querySelector("body"),shortView=document.querySelector(".shortView"),detailedView=document.querySelector(".detailedView"),filters=document.querySelectorAll(".filter"),sortArea=document.querySelector(".sort"),sortWrapper=document.querySelector(".sortBy"),sortItemWrapper=document.querySelector(".sort-wrapper"),sortList=document.querySelectorAll(".sort__item"),submitFilters=document.querySelector(".submitFilters"),resetFilters=document.querySelector(".resetFilters"),products=document.querySelector(".products"),shoppingCart=document.querySelector(".shoppingCart"),shoppingCartProducts=document.querySelector(".shoppingCart-products"),emptyCart=document.querySelector(".empty-cart"),result=document.querySelector(".result-sum"),bin=document.querySelector(".bin"),sendData=document.querySelector(".send-data"),order=document.querySelector(".order"),backToCartButton=document.querySelector(".backToCart");let productsArray,teaObject,sortingSet,short;const changeEvent=new Event("change");function fillInBlock(e){for(object of e)productId=object.id,productName=object.name,productDescription=object.description,productYear=object.year,productType=object.type,productPrice=object.price,productImg=object.img,block=createCard(productId,productName,productDescription,productYear,productType,productPrice,productImg),products.insertAdjacentHTML("beforeend",block)}function createCard(e,t,r,o,c,s,n){return`<div class='productCard'>\n                <img src='${n}'></img>\n                <div id='${e}' class='product'>\n                    <h3 class='product-name'>${t}</h3>\n                    <p class='price'>Цена: <span class='priceValue'>${s}</span> р/г</p>\n                    <div class='addInfo'>                        \n                        <p>Описание: ${r}</p>\n                        <p>Год производства: ${o}</p>\n                        <p class='teaCategory ${c}'>Категория: ${teaObject[c]}</p>\n                    </div>\n                    <br>\n                    <button class='addToCart btn-style2'>добавить в корзину</button>\n                </div>\n            </div>`}function showSort(){for(let e of sortList)e.classList.add("unhideElem");sortItemWrapper.addEventListener("click",(e=>{currentElement=e.target;for(let e of sortList)e.classList.remove("unhideElem");currentElement.classList.add("unhideElem"),sortClass=currentElement.classList[1],"priceHigher"==sortClass?(sortingSet="price",sortedArray=fastSort(productsArray,sortingSet)):"priceLower"==sortClass?(sortingSet="price",sortedArray=fastSort(productsArray,sortingSet),sortedArray.reverse()):"yearNewer"==sortClass?(sortingSet="year",sortedArray=fastSort(productsArray,sortingSet),sortedArray.reverse()):"yearOlder"==sortClass&&(sortingSet="year",sortedArray=fastSort(productsArray,sortingSet)),products.innerHTML="",fillInBlock(sortedArray),sortWithFilters(),short||showDetails(),addToCart(),e.stopPropagation()}),{once:!0})}function fastSort(e,t){if(e.length<2)return e;startPoint=e[0];let r=[],o=[],c=[];for(i=1;i<e.length;i++)e[i][t]>startPoint[t]?o.push(e[i]):r.push(e[i]);return c.push(startPoint),[...fastSort(r,t),...c,...fastSort(o,t)]}function sortWithFilters(){const e=document.querySelectorAll(".productCard");let t=document.querySelectorAll(".tea-category:checked"),r=document.querySelector(".price-category:checked"),o=createFiltersList(t),c=[];if(showAllCards(),0==t.length&&"all-cat"==r.classList[1])return resetFilterSettings(),0;if(0==t.length&&"all-cat"!=r.classList[1])return chosePriceCategory(e,r),0;for(card of e)catElement=card.querySelector(".teaCategory").classList[1],o.includes(catElement)?c.push(card):card.style.display="none";chosePriceCategory(c,r)}function showAllCards(){const e=document.querySelectorAll(".productCard");for(card of e)card.style.display="inline-block"}function resetFilterSettings(){let e=document.querySelector(".all-cat"),t=document.querySelectorAll(".tea-category:checked");for(check of(e.checked=!0,t))check.checked=!1;showAllCards()}function createFiltersList(e){let t=[];for(object of e)t.push(object.classList[1]);return t}function chosePriceCategory(e,t){if(priceCheck=t.value,"more100"==priceCheck)for(card of e)cardPrice=Number(card.querySelector(".priceValue").textContent),cardPrice<100&&(card.style.display="none");else for(card of e)cardPrice=Number(card.querySelector(".priceValue").textContent),cardPrice>Number(priceCheck)&&(card.style.display="none")}function showDetails(){short=!1;const e=document.querySelectorAll(".productCard");for(card of e)card.classList.add("productDetails"),card.querySelector(".addInfo").style.display="inline-block",card.style.textAlign="left",card.querySelector("img").style.float="left"}function hideDetails(){short=!0;const e=document.querySelectorAll(".productCard");for(card of e)card.classList.remove("productDetails"),card.querySelector(".addInfo").style.display="none",card.style.textAlign="center"}function addToCart(){const e=document.querySelectorAll(".addToCart");for(btn of e)btn.addEventListener("click",(e=>{card=e.target.parentNode.parentNode,img=card.querySelector("img").getAttribute("src"),productName=card.querySelector(".product-name").textContent,price=card.querySelector(".priceValue").textContent,alreadyExist=findMatch(productName),alreadyExist||(block=`<div class='cart-product'>\n                        <button class='delete-from-cart-button'>удалить</button>\n                        <div class='cart-img'><img src='${img}'></img></div>\n                        <div>\n                            <p class='cart-name'>Название: <span>${productName}</span></p>\n                            <p class='cart-price'>Цена за грамм: <span>${price}</span></p>\n                            <label>Количество <input value='1' type="number" min='1'/> грамм</label>\n                            <p class='finaly-price'>Итоговая цена <span>${price}</span> &#8381;</p>\n                        </div>\n                    </div>`,shoppingCart.querySelector(".shoppingCart-products").insertAdjacentHTML("beforeend",block),deleteFromCart()),calculatePrice()}))}function deleteFromCart(){let e=document.querySelectorAll(".delete-from-cart-button");e[e.length-1].addEventListener("click",(e=>{1==document.querySelectorAll(".delete-from-cart-button").length&&(emptyCart.style.display="block",result.style.display="none"),e.target.parentNode.remove(),updateResultSum()}))}function findMatch(e){for(card of(cards=document.querySelectorAll(".cart-product"),cards))if(card.querySelector(".cart-name").querySelector("span").textContent==e)return cardInput=card.querySelector("input"),changedValue=Number(cardInput.value)+1,card.querySelector("input").setAttribute("value",changedValue),cardInput.dispatchEvent(changeEvent),!0}function showShoppingCart(){""==shoppingCartProducts.innerHTML?(emptyCart.style.display="block",result.style.display="none"):(emptyCart.style.display="none",result.style.display="block",updateResultSum()),shoppingCart.style.display="inline-block",body.style.overflow="hidden",document.querySelector(".close-shopping-cart").onclick=closeShoppingCart}function closeShoppingCart(){shoppingCart.style.display="none",body.style.overflow="visible"}function calculatePrice(){const e=document.querySelectorAll(".cart-product");e[e.length-1].querySelector("input").addEventListener("change",(e=>{prodCard=e.target.parentNode.parentNode;let t=prodCard.querySelector(".finaly-price").querySelector("span");price=prodCard.querySelector(".cart-price").querySelector("span").innerText,res=e.target.value*Number(price),res<1&&(res=Number(price),e.target.value=1),t.innerHTML=`${res}`,updateResultSum()}))}function updateResultSum(){const e=document.querySelectorAll(".cart-product"),t=document.querySelector(".finally-sum");let r=0;for(product of e){let e=product.querySelector(".finaly-price").querySelector("span").innerText;r+=Number(e)}t.innerHTML=`Итого: ${r} &#8381;`}function makeOrder(){closeShoppingCart(),order.style.display="block",body.style.overflow="hidden"}function backToCart(){order.style.display="none",showShoppingCart()}function hideChecksInFilters(){for(let e of filters)ul=e.nextElementSibling,ul.classList.remove("unhideElem")}request.open("GET",requestURL),request.responseType="json",request.send(),request.onload=function(){let e=request.response;productsArray=e.products,sortedArray=fastSort(productsArray,"price"),teaObject=e.teatype,fillInBlock(sortedArray),resetFilterSettings(),short=!0,addToCart()};for(let e of filters)e.addEventListener("click",(()=>{document.body.clientWidth<820&&(ul=e.nextElementSibling,ul.classList.toggle("unhideElem"),submitFilters.addEventListener("click",hideChecksInFilters),resetFilters.addEventListener("click",hideChecksInFilters))}));sortWrapper.addEventListener("click",showSort),detailedView.addEventListener("click",showDetails),shortView.addEventListener("click",hideDetails),submitFilters.addEventListener("click",sortWithFilters),resetFilters.addEventListener("click",resetFilterSettings),bin.addEventListener("click",showShoppingCart),sendData.addEventListener("click",makeOrder),backToCartButton.addEventListener("click",backToCart);